<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Инженерный расчет: СП 30.13330.2020</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #c5a059;
            --steel: #334155;
            --bg: #f8fafc;
            --border: rgba(197, 160, 89, 0.3);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg);
            color: var(--steel);
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; /* Важно для платформы */
        }

        /* КОМПАКТНАЯ 3D СЦЕНА */
        .scene {
            perspective: 1000px;
            width: 100%; height: 200px;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px;
        }

        .building-3d {
            width: 60px; height: 160px;
            position: relative;
            transform-style: preserve-3d;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate { from { transform: rotateY(0deg) rotateX(10deg); } to { transform: rotateY(360deg) rotateX(10deg); } }

        .wall {
            position: absolute; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--border);
            display: grid; grid-template-rows: repeat(10, 1fr);
        }

        .front { transform: translateZ(30px); }
        .back  { transform: rotateY(180deg) translateZ(30px); }
        .right { transform: rotateY(90deg) translateZ(30px); width: 60px; }
        .left  { transform: rotateY(-90deg) translateZ(30px); width: 60px; }

        .floor { border-bottom: 1px solid rgba(197, 160, 89, 0.1); }
        .floor.active { background: rgba(197, 160, 89, 0.2); box-shadow: inset 0 0 10px var(--gold); }

        /* ИНТЕРФЕЙС */
        .panel {
            width: 100%; max-width: 600px;
            background: #fff; border-radius: 12px;
            padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        h2 { font-size: 0.9rem; text-transform: uppercase; color: var(--gold); margin-bottom: 15px; text-align: center; }
        
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .field { margin-bottom: 15px; }
        label { display: block; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: #64748b; margin-bottom: 5px; font-weight: 700; }
        
        input {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px;
            font-family: 'JetBrains Mono', monospace; font-size: 1rem; box-sizing: border-box;
        }

        .btn {
            width: 100%; padding: 14px; background: var(--steel); color: #fff;
            border: none; border-radius: 6px; cursor: pointer;
            font-weight: 700; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s;
        }
        .btn:hover { background: var(--gold); }

        .dashboard {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            margin-top: 20px; padding-top: 15px; border-top: 1px solid #f1f5f9;
        }
        .stat { text-align: center; }
        .stat-v { display: block; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--gold); font-weight: 700; }
        .stat-l { font-size: 0.55rem; color: #94a3b8; text-transform: uppercase; }

        #toast { position: fixed; bottom: 10px; left: 10px; right: 10px; padding: 10px; background: #ef4444; color: #fff; border-radius: 4px; display: none; font-size: 0.7rem; text-align: center; }
    </style>
</head>
<body>

    <div class="scene">
        <div class="building-3d">
            <div class="wall front"></div><div class="wall back"></div>
            <div class="wall right"></div><div class="wall left"></div>
        </div>
    </div>

    <div class="panel">
        <div id="ph1" class="step active">
            <h2>Шаг 1: Конфигурация</h2>
            <div class="field"><label>Жители (U), чел.</label><input type="number" id="u" placeholder="869"></div>
            <div class="field"><label>Приборы ХВС (N), шт.</label><input type="number" id="n" placeholder="1680"></div>
            <button class="btn" onclick="go1()">Далее</button>
        </div>

        <div id="ph2" class="step">
            <h2>Шаг 2: Вероятность</h2>
            <div class="field"><label>Вероятность Ptot</label><input type="number" step="0.0001" id="p" placeholder="0.0059"></div>
            <div class="field"><label>Коэффициент α</label><input type="number" step="0.001" id="a" placeholder="4.126"></div>
            <button class="btn" onclick="go2()">Рассчитать</button>
        </div>

        <div id="ph3" class="step">
            <h2>Шаг 3: Энергия</h2>
            <div class="field"><label>Расход теплоты QTh, кВт</label><input type="number" step="0.1" id="q" placeholder="176.4"></div>
            <button class="btn" onclick="go3()">Завершить</button>
        </div>

        <div class="dashboard">
            <div class="stat"><span class="stat-v" id="m-q">0.00</span><span class="stat-l">л/с</span></div>
            <div class="stat"><span class="stat-v" id="m-h">0.00</span><span class="stat-l">м³/ч</span></div>
            <div class="stat"><span class="stat-v" id="m-p">0%</span><span class="stat-l">Прогресс</span></div>
        </div>
    </div>

    <div id="toast"></div>

<script>
    // ДАННЫЕ ИЗ ДОКУМЕНТА
    const SOL = { U: 869, N: 1680, P: 0.0059, A: 4.126, Q: 176.4 };

    document.querySelectorAll('.wall').forEach(w => {
        for(let i=0; i<10; i++) w.appendChild(document.createElement('div')).className='floor';
    });

    function showErr(m, ok=false) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.background = ok ? "#10b981" : "#ef4444";
        t.style.display = 'block'; setTimeout(() => t.style.display='none', 2500);
    }

    function go1() {
        if(parseInt(document.getElementById('u').value)===SOL.U && parseInt(document.getElementById('n').value)===SOL.N) {
            document.getElementById('ph1').classList.remove('active');
            document.getElementById('ph2').classList.add('active');
            document.getElementById('m-p').innerText='30%';
            updateFloors(3); sendHeight();
        } else showErr("Ошибка в исходных данных!");
    }

    function go2() {
        if(parseFloat(document.getElementById('p').value)===SOL.P && parseFloat(document.getElementById('a').value)===SOL.A) {
            document.getElementById('ph2').classList.remove('active');
            document.getElementById('ph3').classList.add('active');
            document.getElementById('m-q').innerText='4.126';
            document.getElementById('m-h').innerText='9.74';
            document.getElementById('m-p').innerText='70%';
            updateFloors(7); sendHeight();
        } else showErr("Вероятность или Альфа неверны!");
    }

    function go3() {
        if(Math.abs(parseFloat(document.getElementById('q').value)-SOL.Q) < 0.2) {
            document.getElementById('m-p').innerText='100%';
            updateFloors(10); showErr("Расчет завершен успешно!", true);
        } else showErr("Ошибка в расчете теплоты!");
    }

    function updateFloors(c) {
        document.querySelectorAll('.floor').forEach((f,i) => { if(i%10 < c) f.classList.add('active'); });
    }

    /* АВТО-ВЫСОТА ДЛЯ ПЛАТФОРМЫ */
    function sendHeight() {
        const height = document.documentElement.scrollHeight;
        window.top.postMessage({ frameHeight: height + 20 }, '*');
    }
    window.onload = sendHeight;
    window.onresize = sendHeight;
    const observer = new MutationObserver(sendHeight);
    observer.observe(document.body, { attributes: true, childList: true, subtree: true });
</script>
</body>
</html>